name: Playwright Tests with CTRF Reports

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright Tests
        run: npx playwright test
        env:
          CI: true

      - name: Upload CTRF Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ctrf-report
          path: test-results/ctrf-report.json
          retention-days: 30

      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-html-report
          path: playwright-report/
          retention-days: 30

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: test-results/
          retention-days: 30

  report:
    name: Process Test Reports
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: Download CTRF Report
        uses: actions/download-artifact@v4
        with:
          name: ctrf-report
          path: reports/

      - name: Parse and Display Results
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY

          if [ -f "reports/ctrf-report.json" ]; then
            # Extract metrics using jq
            total=$(jq -r '.results.summary.tests' reports/ctrf-report.json)
            passed=$(jq -r '.results.summary.passed' reports/ctrf-report.json)
            failed=$(jq -r '.results.summary.failed' reports/ctrf-report.json)
            skipped=$(jq -r '.results.summary.skipped' reports/ctrf-report.json)
            duration=$(jq -r '.results.summary.stop - .results.summary.start' reports/ctrf-report.json)
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“Š Total Tests | $total |" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $passed |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $failed |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $skipped |" >> $GITHUB_STEP_SUMMARY
            echo "| â±ï¸ Duration | ${duration}ms |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Add status message
            if [ "$failed" -gt 0 ]; then
              echo "âŒ **Test run completed with failures!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Extract and display failed tests
              echo "## ðŸ’¥ Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo "| Test Name | Error Message |" >> $GITHUB_STEP_SUMMARY
              echo "|-----------|---------------|" >> $GITHUB_STEP_SUMMARY
              
              # Get failed tests from CTRF report
              jq -r '.results.tests[] | select(.status == "failed") | "| " + .name + " | " + (.message // "No error message") + " |"' reports/ctrf-report.json >> $GITHUB_STEP_SUMMARY
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Check the test artifacts for detailed failure information." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **All tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ CTRF report not found!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment PR with Results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');

            try {
              const reportPath = 'reports/ctrf-report.json';
              if (fs.existsSync(reportPath)) {
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                const summary = report.results.summary;
                
                const passRate = ((summary.passed / summary.tests) * 100).toFixed(1);
                
                let comment = `## ðŸ§ª Playwright Test Results
                
                | Metric | Value |
                |--------|-------|
                | ðŸ“Š Total Tests | ${summary.tests} |
                | âœ… Passed | ${summary.passed} |
                | âŒ Failed | ${summary.failed} |
                | â­ï¸ Skipped | ${summary.skipped} |
                | ðŸ“ˆ Pass Rate | ${passRate}% |
                | â±ï¸ Duration | ${summary.stop - summary.start}ms |
                `;
                
                if (summary.failed > 0) {
                  comment += `\nâŒ **${summary.failed} test(s) failed!**\n\n## ðŸ’¥ Failed Tests\n\n| Test Name | Error Message |\n|-----------|---------------|\n`;
                  
                  const failedTests = report.results.tests.filter(test => test.status === 'failed');
                  failedTests.forEach(test => {
                    const errorMsg = (test.message || 'No error message').replace(/\|/g, '\\|').replace(/\n/g, ' ');
                    comment += `| ${test.name} | ${errorMsg} |\n`;
                  });
                  
                  comment += `\nCheck the [workflow run](${context.payload.pull_request.html_url}/checks) for details.`;
                } else {
                  comment += '\nâœ… **All tests passed!** Great job! ðŸŽ‰';
                }
                
                comment += '\n\n---\n*Generated by Playwright CTRF Reporter*';
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            } catch (error) {
              console.log('Error processing report:', error);
            }
